name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build for Linux
        run: cargo build --release --target x86_64-unknown-linux-gnu
      
      - name: Build for macOS
        run: cargo build --release --target x86_64-apple-darwin
      
      - name: Build for Windows
        run: cargo build --release --target x86_64-pc-windows-msvc
      
      - name: Build for ARM64 macOS
        run: cargo build --release --target aarch64-apple-darwin
      
      - name: Create release archives
        run: |
          tar -czf dist_agent_lang-${{ github.ref_name }}-linux-x64.tar.gz target/x86_64-unknown-linux-gnu/release/dist_agent_lang
          tar -czf dist_agent_lang-${{ github.ref_name }}-macos-x64.tar.gz target/x86_64-apple-darwin/release/dist_agent_lang
          tar -czf dist_agent_lang-${{ github.ref_name }}-macos-arm64.tar.gz target/aarch64-apple-darwin/release/dist_agent_lang
          zip dist_agent_lang-${{ github.ref_name }}-windows-x64.zip target/x86_64-pc-windows-msvc/release/dist_agent_lang.exe
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist_agent_lang-${{ github.ref_name }}-linux-x64.tar.gz
            dist_agent_lang-${{ github.ref_name }}-macos-x64.tar.gz
            dist_agent_lang-${{ github.ref_name }}-macos-arm64.tar.gz
            dist_agent_lang-${{ github.ref_name }}-windows-x64.zip
          body: |
            ## dist_agent_lang v${{ github.ref_name }}
            
            ### What's New
            - Multi-chain support for major blockchains
            - Complete smart contract development capabilities
            - AI agent coordination features
            - Comprehensive testing and benchmarking
            
            ### Installation
            ```bash
            # Via cargo
            cargo install dist_agent_lang
            
            # Or download binaries from this release
            ```
            
            ### Quick Start
            ```bash
            dist_agent_lang --version
            dist_agent_lang run examples/smart_contract.dal
            ```
            
            ### Supported Platforms
            - Linux (x86_64)
            - macOS (x86_64, ARM64)
            - Windows (x86_64)
            
            ### Documentation
            - [README](https://github.com/okjason-source/dist_agent_lang#readme)
            - [Examples](https://github.com/okjason-source/dist_agent_lang/tree/main/examples)
            - [Documentation](https://github.com/okjason-source/dist_agent_lang/blob/main/Documentation.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
