name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

env:
  SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
  CARGO_HTTP_CAINFO: /etc/ssl/certs/ca-certificates.crt

jobs:
  # Build on each platform natively (cross-compile doesn't work without extra tooling)
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Fix CA cert path
        run: |
          sudo mkdir -p /usr/local/etc/ca-certificates
          sudo ln -sf /etc/ssl/certs/ca-certificates.crt /usr/local/etc/ca-certificates/cert.pem
          sudo update-ca-certificates

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build release binary
        run: cargo build --release

      - name: Package
        run: |
          mkdir -p staging
          cp target/release/dal staging/
          cp README.md LICENSE CHANGELOG.md staging/ 2>/dev/null || true
          tar -czf dist_agent_lang-${{ github.ref_name }}-linux-x64.tar.gz -C staging .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: dist_agent_lang-${{ github.ref_name }}-linux-x64.tar.gz

  build-macos:
    name: Build macOS (x64 + ARM64)
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build release binary
        run: cargo build --release

      - name: Package
        run: |
          mkdir -p staging
          cp target/release/dal staging/
          cp README.md LICENSE CHANGELOG.md staging/ 2>/dev/null || true
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            tar -czf dist_agent_lang-${{ github.ref_name }}-macos-arm64.tar.gz -C staging .
          else
            tar -czf dist_agent_lang-${{ github.ref_name }}-macos-x64.tar.gz -C staging .
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: dist_agent_lang-${{ github.ref_name }}-macos-*.tar.gz

  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build release binary
        run: cargo build --release

      - name: Package
        shell: bash
        run: |
          mkdir -p staging
          cp target/release/dal.exe staging/
          cp README.md LICENSE CHANGELOG.md staging/ 2>/dev/null || true
          cd staging && 7z a ../dist_agent_lang-${{ github.ref_name }}-windows-x64.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist_agent_lang-${{ github.ref_name }}-windows-x64.zip

  # Create a GitHub Release with all artifacts
  release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -lhR artifacts/

      - name: Create source tarball
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist_agent_lang-${VERSION}
          cp -r src examples docs Cargo.toml Cargo.lock README.md LICENSE CHANGELOG.md dist_agent_lang-${VERSION}/ 2>/dev/null || true
          tar -czf artifacts/dist_agent_lang-${VERSION}-source.tar.gz dist_agent_lang-${VERSION}/

      - name: Determine if pre-release
        id: prerelease
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          if [ "$MAJOR" -lt 1 ] || ([ "$MAJOR" -eq 1 ] && [ "$MINOR" -lt 1 ]); then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          files: artifacts/*
          generate_release_notes: true
          body: |
            ## dist_agent_lang ${{ github.ref_name }}

            ### Installation

            **Download a binary:**
            Pick the archive for your platform from the assets below, extract, and place `dal` on your PATH.

            ```bash
            # Linux x64
            tar xzf dist_agent_lang-${{ github.ref_name }}-linux-x64.tar.gz
            sudo mv dal /usr/local/bin/

            # macOS (ARM64 or x64)
            tar xzf dist_agent_lang-${{ github.ref_name }}-macos-arm64.tar.gz
            sudo mv dal /usr/local/bin/

            # Windows x64 â€” extract the zip, then add dal.exe to your PATH
            ```

            **Build from source:**
            ```bash
            git clone https://github.com/okjason-source/dist_agent_lang.git
            cd dist_agent_lang
            cargo build --release
            # binary is at target/release/dal
            ```

            ### Quick Start
            ```bash
            dal --version
            dal run examples/hello_world_demo.dal
            ```

            ### Documentation
            - [README](https://github.com/okjason-source/dist_agent_lang#readme)
            - [Docs](https://github.com/okjason-source/dist_agent_lang/tree/main/docs)
            - [Examples](https://github.com/okjason-source/dist_agent_lang/tree/main/examples)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
